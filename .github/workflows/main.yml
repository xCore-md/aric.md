name: Deploy on Prod

on:
  pull_request: null
  push:
    branches:
      - main

jobs:
  code_analysis:
    strategy:
      fail-fast: false
      matrix:
        actions:
          -
            name: 'Composer Validate'
            run: composer validate --ansi

          -
            name: 'Coding Standard'
            run: composer phpcs

    name: ${{ matrix.actions.name }}
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v3
      # PHP setup: https://github.com/shivammathur/setup-php
      - uses: shivammathur/setup-php@v2
        with:
          php-version: 8.2
          coverage: none

      # Composer install cache: https://github.com/ramsey/composer-install
      - uses: "ramsey/composer-install@v2"

      - run: ${{ matrix.actions.run }}

  deploy:
    runs-on: ubuntu-latest
    needs: code_analysis
    steps:
      - name: Deploy on Dev Server
        uses: JimCronqvist/action-ssh@master
        with:
          hosts: 'aric@194.33.40.199'
          privateKey: ${{ secrets.DEPLOY_KEY }}
          command: |
            cd ~/htdocs
            chmod +x deploy.sh
            ./deploy.sh